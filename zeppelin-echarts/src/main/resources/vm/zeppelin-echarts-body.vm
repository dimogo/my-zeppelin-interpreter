<div class="container-fluid zeppelin-echarts-example">
    <form class="form-horizontal" role="form">
        <div class="form-group row">
            <label for="inputEmail3" class="col-sm-1 control-label">主标题</label>

            <div class="col-sm-5">
                <input type="text" class="form-control" id="zeppelin-echarts-title" placeholder="图表的主标题"
                #if ($ZeppelinEchartsTitle) value=$ZeppelinEchartsTitile" #else value="" #end >
            </div>
            <label for="inputEmail3" class="col-sm-1 control-label">副标题</label>

            <div class="col-sm-5">
                <input type="text" class="form-control" id="zeppelin-echarts-subtitle" placeholder="图表的副标题"
                #if ($ZeppelinEchartsSubTitle) "$ZeppelinEchartsSubTitle" #else "" #end >
            </div>
        </div>
        <div class="form-group row">
            <label for="inputEmail3" class="col-sm-1 control-label">图表</label>

            <div class="col-sm-2">
                <select id="zeppelin-echarts-type" class="form-control">
                    <option value=""></option>
                    <option value="bar">柱状图</option>
                    <option value="line">折线图</option>
                    <option value="scatter">散点图</option>
                </select>
            </div>
            <label for="inputEmail3" class="col-sm-2 control-label">系列名称</label>

            <div class="col-sm-2">
                <input type="text" class="form-control" id="zeppelin-echarts-serie-name" placeholder="图表系列名称">
            </div>
        </div>
        <div class="form-group row">
            <label for="inputEmail3" class="col-sm-1 control-label">宽度</label>

            <div class="col-sm-2">
                <input type="text" class="form-control" id="inputEmail3" placeholder="图表的宽度">
            </div>
            <label for="inputEmail3" class="col-sm-2 control-label">横坐标字段</label>

            <div class="col-sm-2">
                <select id="zeppelin-echarts-xaxis" class="form-control">
                </select>
            </div>
            <label for="inputEmail3" class="col-sm-2 control-label">横坐标类型</label>

            <div class="col-sm-2">
                <select id="zeppelin-echarts-xaxis-type" class="form-control">
                    <option value="value">数值</option>
                    <option value="category" selected>类目</option>
                    <option value="time">时间</option>
                    <option value="log">对数</option>
                </select>
            </div>
        </div>
        <div class="form-group row">
            <label for="inputEmail3" class="col-sm-1 control-label">高度</label>

            <div class="col-sm-2">
                <input type="text" class="form-control" id="inputEmail3" placeholder="图表的高度">
            </div>
            <label for="inputEmail3" class="col-sm-2 control-label">纵坐标字段</label>

            <div class="col-sm-2">
                <select id="zeppelin-echarts-yaxis" class="form-control">
                </select>
            </div>
            <label for="inputEmail3" class="col-sm-2 control-label">纵坐标类型</label>

            <div class="col-sm-2">
                <select id="zeppelin-echarts-yaxis-type" class="form-control">
                    <option value="value" selected>数值</option>
                    <option value="category">类目</option>
                    <option value="time">时间</option>
                    <option value="log">对数</option>
                </select>
            </div>
        </div>
</div>
<div class="row">
    <div class="col-sm-12">
        <table id="zeppelin-echarts-series" class="table table-bordered">
            <tr>
                <td>#
                <td>名称
                <td>类型
                <td>横坐标字段
                <td>纵坐标字段
                <td>
            </tr>
        </table>
    </div>
</div>
<div class="row">
    <div class="form-group">
        <div class="col-sm-offset-2 col-sm-10">
            <div class="checkbox">
                <label>
                    <input type="checkbox"> Remember me
                </label>
            </div>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-offset-2 col-sm-12">
            <button type="button" id="zeppin-echarts-add-serie" class="btn btn-success">增加系列</button>
            <button type="button" id="zeppin-echarts-refresh-graphic" class="btn btn-success">刷新图表</button>
        </div>
    </div>
    </form>
</div>
<div class="row">
    <div id="zeppelin-echarts-graphic-container" class="col-sm-12">
        <div id="zeppelin-echarts-graphic-body" class="zeppelin-echarts-main"></div>
    </div>
</div>
</div>
<script language="javascript">
    #if ($ZeppelinEChartsOriginJsonData)
    var orginData = $ZeppelinEChartsOriginJsonData;
    #else
    var orginData = [];
    #end
    var graphicBody = null;
    var graphicBodyObj = null;
    var serieConfigs = new Array();

    function fillOriginDataOptionsFromStruct(data) {
        $("#zeppelin-echarts-xaxis").append("<option value=''></option>");
        $("#zeppelin-echarts-yaxis").append("<option value=''></option>");
        for (var key in data) {
            $("#zeppelin-echarts-xaxis").append("<option value='" + key + "'>" + key + "</option>");
            $("#zeppelin-echarts-yaxis").append("<option value='" + key + "'>" + key + "</option>");
        }
    }

    function buildLegendDataBySerieConfigs() {
        var legendData = new Array();
        for (var serieConfigIndex = 0; serieConfigIndex < serieConfigs.length; serieConfigIndex++) {
            legendData.push(serieConfigs[serieConfigIndex].name);
        }
        return legendData;
    }

    function buildSerieDataByOrigin(originData) {
        var seriesData = new Array();
        for (var dataIndex in originData) {
            var data = originData[dataIndex];
            for (var serieConfigIndex = 0; serieConfigIndex < serieConfigs.length; serieConfigIndex++) {
                var serieConfig = serieConfigs[serieConfigIndex]
                var serie = undefined;
                if (seriesData.length < serieConfig.index + 1) {
                    seriesData.push({
                        "name": serieConfig.name,
                        "type": serieConfig.type,
                        "data": new Array()
                    });
                }
                serie = seriesData[serieConfig.index];
                var objData = new Array();
                objData.push(data[serieConfig.xAxis]);
                objData.push(data[serieConfig.yAxis]);
                serie.data.push(objData);
            }
        }
        return seriesData;
    }

    function buildGraphicOption(option) {
        var title = $("#zeppelin-echarts-title").val();
        var subtitle = $("#zeppelin-echarts-subtitle").val();
        option.title.text = title;
        option.title.subtext = subtitle;
        option.xAxis.type = $("#zeppelin-echarts-xaxis-type").val();
        option.yAxis.type = $("#zeppelin-echarts-yaxis-type").val();
        option.series = buildSerieDataByOrigin(orginData);
        option.legend.data = buildLegendDataBySerieConfigs(serieConfigs);
        return option;
    }

    Array.prototype.del = function (index) {
        if (isNaN(index) || index >= this.length) {
            return false;
        }
        for (var i = 0, n = 0; i < this.length; i++) {
            if (this[i] != this[index]) {
                this[n++] = this[i];
            }
        }
        this.length -= 1;
    };

    function updateZeppelinEChartsSeries() {
        $("#zeppelin-echarts-series tr:gt(0)").remove();
        for (var index = 0; index < serieConfigs.length; index++) {
            var cfg = serieConfigs[index];
            $("#zeppelin-echarts-series").append(
                    "<tr><td>" + index
                    + "<td>" + cfg.name
                    + "<td>" + cfg.type
                    + "<td>" + cfg.xAxis
                    + "<td>" + cfg.yAxis
                    + "<td><button name=\"zeppelin-echarts-serie-delete\" type=\"button\" class=\"btn btn-danger\">删除</button>"
                    + "</tr>");
        }
        $("button[name='zeppelin-echarts-serie-delete']").each(function () {
            $(this).click(function () {
                var serieIndex = parseInt($(this).parents("tr").children("td:eq(0)").html())
                serieConfigs.del(serieIndex)
                $(this).parents("tr").remove()
                updateZeppelinEChartsSeries()
            })
        })
    }

    $("#zeppin-echarts-refresh-graphic").click(function () {
        drawChart(false, graphicBodyObj, buildGraphicOption(option));
    });

    $("#zeppin-echarts-add-serie").click(function () {
        serieConfigs.push({
            "index": serieConfigs.length,
            "name": $("#zeppelin-echarts-serie-name").val(),
            "type": $("#zeppelin-echarts-type").val(),
            "xAxis": $("#zeppelin-echarts-xaxis").val(),
            "yAxis": $("#zeppelin-echarts-yaxis").val(),
        });
        updateZeppelinEChartsSeries();
    });

    option = {
        title: {
            text: "",
            subtext: "",
        },
        legend: {
            right: 10,
            data: []
        },
        xAxis: {
            splitLine: {
                lineStyle: {
                    type: 'dashed'
                }
            }
        },
        yAxis: {
            splitLine: {
                lineStyle: {
                    type: 'dashed'
                }
            },
            scale: true
        },
        series: []
    };

    #if ($ZeppelinEchartsOptionSettings && $ZeppelinEchartsOptionSettings.size() > 0)
        try {
            #foreach($entry in $ZeppelinEchartsOptionSettings.entrySet())
                option.$entry.key = $entry.value
            #end
        } catch (e) {
            console.error("option settings error");
        }
    #end

    function drawChart(redraw, chart, option) {
        if (redraw) {
            if (chart && chart.dispose) {
                chart.dispose();
            }
            chart = echarts.init(chart, "macarons");
        }
        chart.showLoading({text: "正在重新绘制图表,请稍候..."})
        try {
            chart.setOption(option, true)
            chart.hideLoading();
        } catch (e) {
            chart.showLoading({text: "绘制图表出错了"});
            console.log(e);
        }
        return chart;
    }

    function getJS(url) {
        return new Promise(function(resolve, reject) {
            var script = document.createElement('script');
            script.type = "text/javascript";

            if (script.readyState){
                script.onreadystatechange = function() {
                    if (script.readyState == "loaded" ||
                            script.readyState == "complete") {
                        script.onreadystatechange = null;
                        resolve('success: '+url);
                    }
                };
            } else {
                script.onload = function() {
                    resolve('success: '+url);
                };
            }

            script.onerror = function() {
                reject(Error(url + 'load error!'));
            };

            script.src = url;
            document.body.appendChild(script);

        });
    }

    function getCSS(url) {
        return new Promise(function(resolve, reject) {
            var css = document.createElement('link');
            css.rel = "stylesheet";

            if (css.readyState){
                css.onreadystatechange = function() {
                    if (css.readyState == "loaded" ||
                            css.readyState == "complete") {
                        css.onreadystatechange = null;
                        resolve('success: '+url);
                    }
                };
            } else {
                css.onload = function() {
                    resolve('success: '+url);
                };
            }

            css.onerror = function() {
                reject(Error(url + 'load error!'));
            };

            css.href = url;
            document.body.appendChild(css);

        });
    }

    function spawn(generatorFunc) {
        function continuer(verb, arg) {
            var result;
            try {
                result = generator[verb](arg);
            } catch (err) {
                return Promise.reject(err);
            }
            if (result.done) {
                return result.value;
            } else {
                return Promise.resolve(result.value).then(onFulfilled, onRejected);
            }
        }
        var generator = generatorFunc();
        var onFulfilled = continuer.bind(continuer, "next");
        var onRejected = continuer.bind(continuer, "throw");
        return onFulfilled();
    }

    var jquery = '$ZeppelinEChartsJQueryUrl',
            echarts   = '$ZeppelinEChartsJSUrl',
            bootstrap = '$ZeppelinEChartsBootstrapURL',
            zeppelinEchartsJS = '/plugins/zeppelin-echarts/js/zeppelin-echarts.js',
            zeppelinEchartsCSS = '/plugins/zeppelin-echarts/css/zeppelin-echarts.css'
            ;

    spawn(function*() {
        try {
            yield getJS(jquery);
            console.log('jquery has loaded');
            yield getJS(echarts);
            console.log('echarts has loaded');
            yield getJS(bootstrap);
            console.log('bootstrap has loaded');
            yield getJS(zeppelinEchartsJS);
            console.log('zeppelinEchartsJS has loaded');
            yield getCSS(zeppelinEchartsCSS);
            console.log('zeppelinEchartsCSS has loaded');
            console.log('all files loaded');

            $(document).ready(function () {
                fillOriginDataOptionsFromStruct(orginData[0]);
                graphicBody = document.getElementById('zeppelin-echarts-graphic-body');
                graphicBodyObj = echarts.init(graphicBody, "macarons");
                drawChart(false, graphicBodyObj, option);
            });
        } catch (err) {
            console.log(err);
        }
    });
</script>
#if ($ZeppelinEChartsBodyFoot)
    $ZeppelinEChartsBodyFoot
#end